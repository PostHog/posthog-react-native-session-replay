name: 'Release'

permissions:
  contents: read

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:

# Concurrency control: only one release process can run at a time
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  check-changesets:
    name: Check for changesets
    runs-on: ubuntu-latest
    # Run when PR with 'release' label is merged to main, or when manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request'
       && github.event.pull_request.merged == true
       && contains(github.event.pull_request.labels.*.name, 'release'))
    outputs:
      has-changesets: ${{ steps.check.outputs.has-changesets }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Check for changesets
        id: check
        run: |
          if [ ! -d ".changeset" ] || [ -z "$(ls -A .changeset/*.md 2>/dev/null | grep -v README.md)" ]; then
            echo "‚ùå No changesets found. Cannot proceed with release."
            echo "Please ensure your PR includes a changeset file."
            echo "has-changesets=false" >> "$GITHUB_OUTPUT"
          else
            echo "‚úì Found changesets to process"
            echo "has-changesets=true" >> "$GITHUB_OUTPUT"
          fi

  notify-approval-needed:
    name: Notify Slack - Approval Needed
    needs: check-changesets
    if: needs.check-changesets.outputs.has-changesets == 'true'
    uses: PostHog/.github/.github/workflows/notify-approval-needed.yml@main
    with:
      slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
      slack_user_group_id: ${{ vars.GROUP_CLIENT_LIBRARIES_SLACK_GROUP_ID }}
    secrets:
      slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
      posthog_project_api_key: ${{ secrets.POSTHOG_PROJECT_API_KEY }}

  version-bump:
    name: Bump version and commit to main
    needs: [check-changesets, notify-approval-needed]
    runs-on: ubuntu-latest
    # Use `always()` to ensure the job runs even if the notify-approval-needed job fails
    if: always() && needs.check-changesets.outputs.has-changesets == 'true'
    environment: 'NPM Release' # Requires approval from a maintainer
    permissions:
      contents: write
    outputs:
      committed: ${{ steps.commit-version-bump.outputs.committed }}
      new-version: ${{ steps.apply-changesets.outputs.new-version }}
    steps:
      - name: Notify Slack - Approved
        continue-on-error: true
        uses: PostHog/.github/.github/actions/slack-thread-reply@main
        with:
          slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
          slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
          thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
          message: '‚úÖ Release approved! Version bump in progress...'
          emoji_reaction: 'white_check_mark'

      - name: Get GitHub App token
        id: releaser
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP_POSTHOG_REACT_NATIVE_SESSION_REPLAY_RELEASER_APP_ID }}
          private-key: ${{ secrets.GH_APP_POSTHOG_REACT_NATIVE_SESSION_REPLAY_RELEASER_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ steps.releaser.outputs.token }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Apply changesets and update version
        id: apply-changesets
        run: |
          pnpm changeset version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new-version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "New version: $NEW_VERSION"

      - name: Update lockfile
        run: pnpm install --no-frozen-lockfile

      - name: Commit version bump and lockfile
        id: commit-version-bump
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore: release v${{ steps.apply-changesets.outputs.new-version }} [version bump]"
            git push origin main
            echo "committed=true" >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ steps.releaser.outputs.token }}

  notify-rejected:
    name: Notify Slack - Rejected
    needs: [version-bump, notify-approval-needed]
    runs-on: ubuntu-latest
    if: always() && needs.version-bump.result == 'failure' && needs.notify-approval-needed.outputs.slack_ts != ''
    steps:
      - name: Check for rejection
        id: check-rejection
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RESPONSE=$(gh api /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/approvals)
          REJECTED=$(echo "$RESPONSE" | jq '[.[] | select(.state == "rejected")] | length')
          if [ "$REJECTED" -gt 0 ]; then
            echo "was_rejected=true" >> "$GITHUB_OUTPUT"
            COMMENT=$(echo "$RESPONSE" | jq -r '.[] | select(.state == "rejected") | .comment // empty' | head -1)
            if [ -n "$COMMENT" ]; then
              {
                echo 'message<<EOF'
                echo "üö´ Release was rejected: $COMMENT"
                echo 'EOF'
              } >> "$GITHUB_OUTPUT"
            else
              echo "message=üö´ Release was rejected." >> "$GITHUB_OUTPUT"
            fi
          else
            echo "was_rejected=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Slack - Rejected
        if: steps.check-rejection.outputs.was_rejected == 'true'
        continue-on-error: true
        uses: PostHog/.github/.github/actions/slack-thread-reply@main
        with:
          slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
          slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
          thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
          message: '${{ steps.check-rejection.outputs.message }}'
          emoji_reaction: 'no_entry_sign'

  publish:
    name: Publish to NPM
    needs: [version-bump, notify-approval-needed]
    runs-on: ubuntu-latest
    if: always() && needs.version-bump.outputs.committed == 'true'
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Check package version
        id: check-package-version
        uses: PostHog/check-package-version@v2.1.0

      - name: Build package
        if: steps.check-package-version.outputs.is-new-version == 'true'
        run: pnpm prepare

      - name: Tag repository
        if: steps.check-package-version.outputs.is-new-version == 'true'
        run: |
          git tag -a "v${{ steps.check-package-version.outputs.committed-version }}" -m "v${{ steps.check-package-version.outputs.committed-version }}"

      - name: Publish to NPM
        if: steps.check-package-version.outputs.is-new-version == 'true'
        run: pnpm publish --access public --no-git-checks
        env:
          NPM_CONFIG_PROVENANCE: true

      - name: Push tag to GitHub
        if: steps.check-package-version.outputs.is-new-version == 'true'
        run: |
          git push origin "v${{ steps.check-package-version.outputs.committed-version }}"

      - name: Create GitHub release
        if: steps.check-package-version.outputs.is-new-version == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read from the first until the second header in the changelog file
          LAST_CHANGELOG_ENTRY=$(awk -v defText="see CHANGELOG.md" '/^## /{if (flag) exit; flag=1} flag && /^##$/{exit} flag; END{if (!flag) print defText}' CHANGELOG.md)
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/releases \
            -f tag_name="v${{ steps.check-package-version.outputs.committed-version }}" \
            -f target_commitish='main' \
            -f name="v${{ steps.check-package-version.outputs.committed-version }}" \
            -f body="$LAST_CHANGELOG_ENTRY" \
            -F draft=false \
            -F prerelease=false \
            -F generate_release_notes=false

      # Notify in case of failure
      - name: Send failure event to PostHog
        if: ${{ failure() }}
        uses: PostHog/posthog-github-action@v0.1
        with:
          posthog-token: '${{ secrets.POSTHOG_PROJECT_API_KEY }}'
          event: 'posthog-react-native-session-replay-release-workflow-failure'
          properties: >-
            {
              "commitSha": "${{ github.sha }}",
              "jobStatus": "${{ job.status }}",
              "ref": "${{ github.ref }}",
              "packageVersion": "${{ steps.check-package-version.outputs.committed-version }}"
            }

      - name: Notify Slack - Failed
        continue-on-error: true
        if: ${{ failure() && needs.notify-approval-needed.outputs.slack_ts != '' }}
        uses: PostHog/.github/.github/actions/slack-thread-reply@main
        with:
          slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
          slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
          thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
          message: '‚ùå Failed to release `posthog-react-native-session-replay@v${{ steps.check-package-version.outputs.committed-version }}`! <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>'
          emoji_reaction: 'x'

  notify-released:
    name: Notify Slack - Released
    needs: [notify-approval-needed, publish]
    runs-on: ubuntu-latest
    if: always() && needs.publish.result == 'success' && needs.notify-approval-needed.outputs.slack_ts != ''
    steps:
      - name: Notify Slack - Released
        continue-on-error: true
        uses: PostHog/.github/.github/actions/slack-thread-reply@main
        with:
          slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
          slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
          thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
          message: 'üöÄ `posthog-react-native-session-replay` released successfully!'
          emoji_reaction: 'rocket'
